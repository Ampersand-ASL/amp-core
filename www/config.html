<html>
    <head>
        <title>Ampersand Configuration</title>
        <style>
body {
    font-family: sans-serif;
}

#config-form {
    width: 500px;
    display: grid;
    grid-template-columns: 1fr 2fr; /* Creates two columns, the second twice as wide */
    gap: 10px; /* Adds space between rows and columns */
    max-width: 500px; /* Optional: sets a max width for the form itself */
}

#config-form label {
  text-align: right;
}

.save-button {
    background-color: #38dc38;
    width: 100px;
}
        </style>
    </head>
    <body>
        <h1>Ampersand ASL Server</h1>
        <form id="config-form">
            <label for="node">Node Number:</label>
            <input type="text" id="node" name="node"/>
            <label for="password">Password:</label>
            <input type="text" id="password" name="password"/>
            <label for="audioDevice">Audio Device:</label>
            <select id="audioDevice" name="audioDevice">
            </select>
            <label for="iaxPort4">IAX Port (IPv4):</label>
            <input type="text" id="iaxPort4" name="iaxPort4"/>
            <span></span>
            <input type="submit" value="Save" class="save-button"/>
        </form>
        <hr/>
        <a href="/">Home</a>
        <br/>
        <br/>
        <span><i>Bruce MacKinnon KC1FSZ bruce@mackinnon.com</i></span>
    </body>
    <script>

async function load_audiodevice_menu() {
    try {
        const response = await fetch('audiodevice-list');
        // Check if the request was successful (status in the 200s)
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        const sel = document.getElementById('audioDevice');
        sel.replaceChildren();
        for (const i of data) {
            var opt = document.createElement('option');
            opt.value = i["query"]
            opt.innerHTML = i["bus"] + "/" + i["port"] + " " + i["desc"]
            sel.appendChild(opt);
        }
    } catch (error) {
        console.error('Error fetching data:', error.message);
    }
}

async function config_load() {
    try {
        const response = await fetch('config-load');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        console.log("config_load", data)
        // Store the entire config document 
        sessionStorage.setItem("config", JSON.stringify(data))
        // Pull out some specific values for this screen
        document.getElementById("node").setAttribute("value", data["node"]);
        document.getElementById("password").setAttribute("value", data["password"]);
        document.getElementById("audioDevice").value = data["audioDevice"];
        document.getElementById("iaxPort4").setAttribute("value", data["iaxPort4"]);
    } catch (error) {
        console.error('Error fetching data:', error.message);
    }
}

function config_save() {
    const form = document.getElementById('config-form');
    const formData = new FormData(form);
    const formObject = Object.fromEntries(formData.entries());
    // Move across a few specific things 
    fullConfig = JSON.parse(sessionStorage.getItem("config"))
    //console.log("Full Config", fullConfig);
    fullConfig["node"] = formObject["node"].trim();
    fullConfig["password"] = formObject["password"].trim();
    fullConfig["audioDevice"] = formObject["audioDevice"].trim();
    fullConfig["iaxPort4"] = formObject["iaxPort4"].trim();
    console.log("Full Config + Changes", fullConfig)
    // Push back to the server
    fetch('/config-save', {
        method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(fullConfig, null, 2)
        }
    );
}

document.addEventListener('DOMContentLoaded', async() => {

    load_audiodevice_menu();
    config_load();

    // Add a submit event listener to the form
    document.getElementById('config-form').addEventListener('submit', function (event) {
        event.preventDefault();
        config_save();
    });   
});
    </script>
</html>
