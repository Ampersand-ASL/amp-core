<html>
    <head>
        <title>Ampersand Configuration</title>
        <link rel="stylesheet" href="main.css">
        <style>
.form2 {
    width: 700px;
    display: grid;
    grid-template-columns: 1fr 2fr; /* Creates two columns, the second twice as wide */
    gap: 10px; /* Adds space between rows and columns */
    border: solid 1px white;
    margin-bottom: 5px;
    padding: 10px;
    background-color: #3e3e42;
}

#config-form label {
  text-align: right;
}

.save-button {
    width: 100px;
}

#favorites {
    resize: none;
}

        </style>
    </head>
    <body>
        <div class="title-row">
            <span class="title-span">Ampersand ASL Server</span>
        </div>
        <div class="tab-row" role="tablist">
            <div class="tab" role="tab" aria-selected="false">
                <a href="/">Home</a>
            </div>
            <div class="tab tab" role="tab" aria-selected="true">
                <a href="config">Configuration</a>
            </div>
            <div class="tab" role="tab" aria-selected="false">
                <a href="log">Log</a>
            </div>
        </div>
        <div class="content-row" role="tabpanel">
            <form id="config-form">
                <div class="form2">
                    <label for="node">Node Number:</label>
                    <input type="text" id="node" name="node"/>
                    <label for="password">Password:</label>
                    <input type="text" id="password" name="password"/>
                    <label for="callsign">Callsign:</label>
                    <input type="text" id="callsign" name="callsign" maxlength="32"/>
                    <label for="iaxPort">IAX Port:</label>
                    <input type="text" id="iaxPort" name="iaxPort"/>
                    <label for="favorites">Favorites:</label>
                    <textarea name="favorites" id="favorites" rows="4"></textarea>
                </div>
                <div class="form2">
                    <div>Radio 0:</div><div></div>
                    <label for="setupMode">Setup Mode:</label>
                    <select id="setupMode" name="setupMode">
                        <option value="0">C-Media CM1xx URI/UCI</option>
                        <!--
                        <option value="1">Ampersand Mode</option>
                        -->
                    </select>
                    
                    <label for="aslHdwType">Hardware Type:</label>
                    <select id="aslHdwType" name="aslHdwType">
                        <option value="0">0: USB radio interfaces designed for app_rpt</option>
                        <!--
                        <option value="1">1: Dingotel/Sph interfaces</option>
                        <option value="2">2: NHC (N1KDO) interfaces</option>
                        <option value="3">3: Custom</option>
                    -->
                    </select>
                    <label for="aslAudioDevice">Audio Device:</label>
                    <select id="aslAudioDevice" name="aslAudioDevice">
                    </select>
                    <label for="aslCosFrom">Carrier From:</label>
                    <select id="aslCosFrom" name="aslCosFrom">
                        <option value="none">None</option>
                        <option value="usb">USB</option>
                        <option value="usbinvert">USB Inverted (Active Low)</option>
                    </select>
                    <label for="aslCtcssFrom">CTCSS From:</label>
                    <select id="aslCtcssFrom" name="aslCtcssFrom" disabled>
                        <option value="none">None</option>
                        <option value="usb">USB</option>
                        <option value="usbinvert">USB Inverted (Active Low)</option>
                    </select>
                    <label for="aslInvertPtt">Invert PTT:</label>
                    <select id="aslInvertPtt" name="aslInvertPtt" disabled>
                        <option value="no">No (Active Low)</option>
                        <option value="yes">Yes (Active High)</option>
                    </select>

                    <label for="aslTxMixASet">Transmit Mixer A:</label>
                    <select id="aslTxMixASet" name="aslTxMixASet">
                    </select>
                    <label for="aslTxMixBSet">Transmit Mixer B:</label>
                    <select id="aslTxMixBSet" name="aslTxMixBSet">
                    </select>
                    <label for="aslRxMixerSet">Receive Mixer:</label>
                    <select id="aslRxMixerSet" name="aslRxMixerSet">
                    </select>
                </div>
                <div class="form2">
                    <div>Advanced Settings:</div><div></div>
                    <label for="kfnodes">Kerchunk Filter Nodes:</label>
                    <textarea name="kfnodes" id="kfnodes" rows="2"></textarea>
                    <label for="kfdelay">Kerchunk Filter Delay (ms):</label>
                    <input type="number" id="kfdelay" name="kfdelay"/>
                </div>
                <span></span>
                <input type="submit" value="Save" class="green-button save-button"/>
            </form>
        </div> <!-- /content-row -->
        <div class="footer-row">
            <span><i><a href="https://www.qrz.com/db/KC1FSZ">Bruce MacKinnon KC1FSZ bruce@mackinnon.com</a></i></span>
        </div> <!-- /footer-row -->
    </body>
    <script>

/**
 * A utility function for populating the options on a select menu
 * using choices provided by the back-end.
 * 
 * @param baseElId The ID of the base element, usually the form that contains
 * the select menu.
 * @param selectName The ID of the select menu and also the name argument 
 * sent to the server.
 * @param args Optional arguments that can influence the list
 */
async function loadSelectOptions(baseElId, selectId, arg) {

    // Get the starting value
    const baseEl = document.getElementById(baseElId);
    const sel = baseEl.querySelector("#" + selectId);
    const initialValue = sel.value

    // Pull up the choices from the server
    try {
        u = "config-select-options?name=" + selectId;
        if (arg)
            u += "&arg=" + arg
        const response = await fetch(u);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        // Clear existing options
        sel.replaceChildren();
        if (data.length > 0) {
            sel.disabled = false;
            for (const i of data) {
                var opt = document.createElement('option');
                opt.value = i["value"]
                opt.innerHTML = i["desc"]
                sel.appendChild(opt);
            }
            // Get the item selected again
            if (initialValue && initialValue != "") {
                sel.value = initialValue
            }
        }
        else {
            sel.disabled = true;
        }

    } catch (error) {
        console.error('Error fetching data:', error.message);
    }
}

function loadUi(name, data, doc) {
    el = doc.getElementById(name);
    if (el) {
        if (name in data) {
            el.value = data[name];
        } else {
            el.value = null;
            el.disabled = true;
        }
    }
}

function storeUi(name, formObject, data) {
    if (name in formObject)
        data[name] = formObject[name].trim();
}

// Call this whenever the audio device selection changes so that 
// the mixer ranges are appropriate for that device.
async function fixMixerRanges() {
    // Get the value of the audio device selected
    sel = document.getElementById("aslAudioDevice");
    await Promise.all([
        loadSelectOptions("config-form", "aslTxMixASet", sel.value),
        loadSelectOptions("config-form", "aslTxMixBSet", sel.value),
        loadSelectOptions("config-form", "aslRxMixerSet", sel.value)
    ]);
}

// Loads data into the configuration screen
async function configLoad() {
    try {
        const response = await fetch('config-load');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        // Store the entire config document so that we can merge later
        sessionStorage.setItem("config", JSON.stringify(data))

        // ----- Top Section -----------------------------------------------------

        loadUi("node", data, document)
        loadUi("password", data, document)
        loadUi("callsign", data, document)
        loadUi("iaxPort", data, document)
        loadUi("favorites", data, document)

        // ----- Radio 0 Section --------------------------------------------------

        loadUi("setupMode", data, document)
        loadUi("aslHdwType", data, document)
        loadUi("aslAudioDevice", data, document)
        loadUi("aslCosFrom", data, document)
        loadUi("aslCtcssFrom", data, document)
        loadUi("aslInvertPtt", data, document)
        loadUi("aslTxMixASet", data, document)
        loadUi("aslTxMixBSet", data, document)
        loadUi("aslRxMixerSet", data, document)

        // ----- Advanced Section --------------------------------------------------

        loadUi("kfnodes", data, document);
        loadUi("kfdelay", data, document);

    } catch (error) {
        console.error('Error fetching configuration data:', error.message);
    }
}

function configStore() {

    const form = document.getElementById('config-form');
    const formData = new FormData(form);
    const formObject = Object.fromEntries(formData.entries());

    // Make a deep copy of the existing config state
    fullConfig = JSON.parse(sessionStorage.getItem("config"))

    // Move across a few specific things 

    // ----- Top Section -----------------------------------------------------

    storeUi("node", formObject, fullConfig)
    storeUi("password", formObject, fullConfig)
    storeUi("callsign", formObject, fullConfig)
    storeUi("iaxPort", formObject, fullConfig)
    storeUi("favorites", formObject, fullConfig)

    // ----- Radio 0 Section --------------------------------------------------

    storeUi("setupMode", formObject, fullConfig)
    storeUi("aslHdwType", formObject, fullConfig)
    storeUi("aslAudioDevice", formObject, fullConfig)
    storeUi("aslCosFrom", formObject, fullConfig)
    storeUi("aslCtcssFrom", formObject, fullConfig)
    storeUi("aslInvertPtt", formObject, fullConfig)
    storeUi("aslTxMixASet", formObject, fullConfig)
    storeUi("aslTxMixBSet", formObject, fullConfig)
    storeUi("aslRxMixerSet", formObject, fullConfig)

    // ----- Advanced Section --------------------------------------------------

    storeUi("kfnodes", formObject, fullConfig);
    storeUi("kfdelay", formObject, fullConfig);

    // Push back to the server
    fetch('/config-save', {
        method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(fullConfig, null, 2)
        }
    );
}

document.addEventListener('DOMContentLoaded', async() => {

    document.getElementById('config-form').addEventListener('submit', function (event) {
        event.preventDefault();
        configStore();
    });   

    // Since the mixer menus depend on the selected audio deveice we need to attach 
    // a change notification callaback
    document.getElementById("aslAudioDevice").addEventListener("change", function(event) {
        fixMixerRanges();
    });

    // Important that these steps are serialized
    await loadSelectOptions("config-form", "aslAudioDevice");
    await configLoad();
    // This depends on which option was chosen on the sound device
    await fixMixerRanges();
    // A second load to get the mixer level menus loaded properly
    // #### TODO: Clean up this hack
    await configLoad();
});
    </script>
</html>
