<html>
    <head>
        <title>Ampersand Home Page</title>
        <style>
/* https://www.color-hex.com/color-palette/98179)             */
body {
    font-family: sans-serif;
}

.fav-button {
    background-color: #38dc38;
}

#connect-button {
    background-color: #38dc38;
}

.disconnect-button {
    background-color: #ff5c5c;
}

#cos-active {
    text-align: center;
    width: 120px;
    padding: 3px;
    color: #00FF00;
    background-color: black;
}

#cos-inactive {
    text-align: center;
    width: 120px;
    padding: 3px;
}

#ptt-button {
    width: 200px;
    height: 40px;
}

#ptt-button.selected {
    background-color: green;
}

table, th, td {
  border: 1px solid black; /* Sets a visible border */
}

table {
  border-collapse: collapse; /* Merges adjacent borders */
}

td {
    padding: 5px;
}
        </style>
    </head>
    <body>
        <h1>Ampersand ASL Server</h1>
        <form id="status-form">
            <input class="fav-button" name="fav1" type="submit" value="ASL Parrot"/>
            <input class="fav-button" name="fav0" type="submit" value="TX Parrot"/>
            <input class="fav-button" name="fav2" type="submit" value="East Cost Reflector"/>
            <br/>
            <br/>
            <input id="node" name="node" type="text" placeholder="Node Number"/>
            <input id="connect-button" name="call" type="submit" value="Connect"/>
            <input class="disconnect-button" id="drop-button" name="drop" type="submit" value="Disconnect"/>
            <br/>
            <br/>
            <input class="disconnect-button" id="disconnect-button" name="dropall" type="submit" value="Disconnect All"/>
            <p><div id="cos-inactive"> COS Inactive </div><div id="cos-active"> COS Active </div></p>
            <p>Connections:</p>
            <table>
                <thead>
                    <th>Node</th>
                    <th>Connections</th>
                </thead>
                <tbody id="connection-table-body">
                </tbody>
            </table>
            <br/>
            <input id="ptt-button" name="ptt" type="submit" value="PTT"/>
            <br/>
            <br/>
            <input id="capture-button" name="capture" type="submit" value="Capture"/>
            <br/>
            <br/>
            <table>
                <tr>
                    <td><input id="dtmf1-button" name="dtmf1" type="submit" value="1"/></td>
                    <td><input id="dtmf2-button" name="dtmf2" type="submit" value="2"/></td>
                    <td><input id="dtmf3-button" name="dtmf3" type="submit" value="3"/></td>
                    <td><input id="dtmfA-button" name="dtmfA" type="submit" value="A"/></td>
                </tr>
                <tr>
                    <td><input id="dtmf4-button" name="dtmf4" type="submit" value="4"/></td>
                    <td><input id="dtmf5-button" name="dtmf5" type="submit" value="5"/></td>
                    <td><input id="dtmf6-button" name="dtmf6" type="submit" value="6"/></td>
                    <td><input id="dtmfB-button" name="dtmfB" type="submit" value="B"/></td>
                </tr>
                <tr>
                    <td><input id="dtmf7-button" name="dtmf7" type="submit" value="7"/></td>
                    <td><input id="dtmf8-button" name="dtmf8" type="submit" value="8"/></td>
                    <td><input id="dtmf9-button" name="dtmf9" type="submit" value="9"/></td>
                    <td><input id="dtmfc-button" name="dtmfC" type="submit" value="C"/></td>
                </tr>
                <tr>
                    <td><input id="dtmfstar-button" name="dtmf*" type="submit" value="*"/></td>
                    <td><input id="dtmf0-button" name="dtmf0" type="submit" value="0"/></td>
                    <td><input id="dtmfpound-button" name="dtmf#" type="submit" value="#"/></td>
                    <td><input id="dtmfD-button" name="dtmfD" type="submit" value="D"/></td>
                </tr>
            </table>
        </form>
        <hr/>
        <a href="config">Configuration</a>
        <br/>
        <br/>
        <span><i>Bruce MacKinnon KC1FSZ bruce@mackinnon.com</i></span>
    </body>
    <script>

async function status_update() {
    const response = await fetch('status');
    if (response.ok) {
        const data = await response.json();
        if (data["cos"]) {
            document.getElementById("cos-active").hidden = false
            document.getElementById("cos-inactive").hidden = true
        } else {
            document.getElementById("cos-active").hidden = true
            document.getElementById("cos-inactive").hidden = false
        }
        if (data["ptt"]) {
            document.getElementById("ptt-button").classList.add("selected")
        } else {
            document.getElementById("ptt-button").classList.remove("selected")
        }

        tbody = document.getElementById("connection-table-body")
        tbody.replaceChildren();
        for (c of data["connections"]) {
            var tr = document.createElement('tr');
            var td0 = document.createElement('td');
            var td1 = document.createElement('td');
            tr.appendChild(td0);
            tr.appendChild(td1);
            var a = document.createElement('a');
            a.innerHTML = c["node"];
            a.setAttribute("href", "https://stats.allstarlink.org/stats/" + c["node"]);
            td0.appendChild(a);
            var first = true;
            for (c1 of c["connections"]) {
                if (!first) {
                    var s = document.createElement("span");
                    s.innerHTML = "&nbsp;"
                    td1.appendChild(s);
                }
                var s = document.createElement("a");
                s.innerHTML = c1;
                s.setAttribute("href", "https://stats.allstarlink.org/stats/" + c1);
                td1.appendChild(s);
                first = false;
            }
            tbody.appendChild(tr);
        }
    }
}

function status_save(buttonName) {
    const form = document.getElementById('status-form');
    const formData = new FormData(form);
    const formObject = Object.fromEntries(formData.entries());

    if (buttonName == "fav0") {
        buttonName = "call"
        formObject["node"] = "55553"
    } else if (buttonName == "fav1") {
        buttonName = "call"
        formObject["node"] = "61057"
    } else if (buttonName == "fav2") {
        buttonName = "call"
        formObject["node"] = "27339"
    }

    formObject["button"] = buttonName;
    const jsonString = JSON.stringify(formObject, null, 2);
    fetch('/status-save', {
        method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: jsonString,
        }
    );
}

document.addEventListener('DOMContentLoaded', async () => {
    document.getElementById("cos-active").hidden = true
    // Install a fast timer to get updates
    setInterval(async () => {
        status_update();
    }, 500);
    document.getElementById('status-form').addEventListener('submit', function (event) {
        event.preventDefault();
        status_save(event.submitter.name);
        // Clear the entry 
        document.getElementById('node').value = ""
        status_update();
    });   
});
    </script>
</html>
