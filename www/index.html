<!--
Ampersand ASL Server Project
Copyright (C) 2026, Bruce MacKinnon KC1FSZ
-->
<html>
    <head>
        <title>Ampersand Home Page</title>
        <style>
body {
    font-family: sans-serif;
    background-color: #1e1e1e;
    color: white;
}

input[type="submit"] {
  border: 2px solid white;
}

h1 {
    font-size: 20px;
}

a {
  color: white;
}

.fav-button {
    background-color: #38dc38;
}

#connect-button {
    background-color: #38dc38;
}

.disconnect-button {
    background-color: #ff5c5c;
}

#cos-active {
    text-align: center;
    width: 120px;
    padding: 3px;
    color: #00FF00;
    background-color: black;
}

#cos-inactive {
    text-align: center;
    width: 120px;
    padding: 3px;
}

#ptt-button {
    width: 200px;
    height: 40px;
}

#ptt-button.selected {
    background-color: green;
}

table, th, td {
  border: 1px solid black; /* Sets a visible border */
}

.no-border-table, .no-border-table th, .no-border-table td {
  border: none;
  border-collapse: collapse;
}

.led-table td {
    padding: 2px;
}

.led-table tr.legend td {
    font-size: 6px;
    text-align: center;
    border-top: 1px solid white;
}

.led {
  width: 10px; 
  height: 10px; 
  border-radius: 2px; 
  visibility: hidden;
}

.led-table tr td:first-child {
    text-align: right;
    font-size: 10px;
}

.ledgr {
  background-color: green;  
}

.ledyl {
  background-color: yellow;  
}

.ledrd {
  background-color: red;
}

.bottom-row {
    display: flex;
    gap: 20px;
}
        </style>
    </head>
    <body>
        <div class="title-row">
            <h1>Ampersand ASL Server</h1>
        </div>
        <form id="status-form">
            <input class="fav-button" name="fav1" type="submit" value="ASL Parrot"/>
            <input class="fav-button" name="fav0" type="submit" value="TX Parrot"/>
            <input class="fav-button" name="fav2" type="submit" value="East Cost Reflector"/>
            <br/>
            <br/>
            <input id="node" name="node" type="text" placeholder="Node Number"/>
            <input id="connect-button" name="call" type="submit" value="Connect"/>
            <input class="disconnect-button" id="drop-button" name="drop" type="submit" value="Disconnect"/>
            <br/>
            <br/>
            <input class="disconnect-button" id="disconnect-button" name="dropall" type="submit" value="Disconnect All"/>
            <p><div id="cos-inactive"> COS Inactive </div><div id="cos-active"> COS Active </div></p>
            <p>Connections:</p>
            <table>
                <thead>
                    <th>Node</th>
                    <th>Remote Node</th>
                    <th>Connections</th>
                </thead>
                <tbody id="connection-table-body">
                </tbody>
            </table>
            <br/>
            <input id="ptt-button" name="ptt" type="submit" value="PTT"/>
            <br/>
            <br/>
            <input id="capture-button" name="capture" type="submit" value="Capture"/>
            <br/>
            <br/>
    <br/>
    <!-- Organizes the DTMF pad and the Level meters -->
    <div class="bottom-row">
        <!-- Left Side-->
        <div>
            <table>
                <tr>
                    <td><input id="dtmf1-button" name="dtmf1" type="submit" value="1"/></td>
                    <td><input id="dtmf2-button" name="dtmf2" type="submit" value="2"/></td>
                    <td><input id="dtmf3-button" name="dtmf3" type="submit" value="3"/></td>
                    <td><input id="dtmfA-button" name="dtmfA" type="submit" value="A"/></td>
                </tr>
                <tr>
                    <td><input id="dtmf4-button" name="dtmf4" type="submit" value="4"/></td>
                    <td><input id="dtmf5-button" name="dtmf5" type="submit" value="5"/></td>
                    <td><input id="dtmf6-button" name="dtmf6" type="submit" value="6"/></td>
                    <td><input id="dtmfB-button" name="dtmfB" type="submit" value="B"/></td>
                </tr>
                <tr>
                    <td><input id="dtmf7-button" name="dtmf7" type="submit" value="7"/></td>
                    <td><input id="dtmf8-button" name="dtmf8" type="submit" value="8"/></td>
                    <td><input id="dtmf9-button" name="dtmf9" type="submit" value="9"/></td>
                    <td><input id="dtmfc-button" name="dtmfC" type="submit" value="C"/></td>
                </tr>
                <tr>
                    <td><input id="dtmfstar-button" name="dtmf*" type="submit" value="*"/></td>
                    <td><input id="dtmf0-button" name="dtmf0" type="submit" value="0"/></td>
                    <td><input id="dtmfpound-button" name="dtmf#" type="submit" value="#"/></td>
                    <td><input id="dtmfD-button" name="dtmfD" type="submit" value="D"/></td>
                </tr>
            </table>
        </div>
        <!-- Right Side-->
         <div>
            <table class="no-border-table led-table">
                <tr class="usb-rx-meter">
                    <td>USB RX</td>
                    <td><div class="led ledgr"></div></td>
                    <td><div class="led ledgr"></div></td>
                    <td><div class="led ledgr"></div></td>
                    <td><div class="led ledgr"></div></td>
                    <td><div class="led ledgr"></div></td>
                    <td><div class="led ledgr"></div></td>
                    <td><div class="led ledgr"></div></td>
                    <td><div class="led ledgr"></div></td>
                    <td><div class="led ledgr"></div></td>
                    <td><div class="led ledgr"></div></td>
                    <td><div class="led ledgr"></div></td>
                    <td><div class="led ledyl"></div></td>
                    <td><div class="led ledyl"></div></td>
                    <td><div class="led ledyl"></div></td>
                    <td><div class="led ledrd"></div></td>
                    <td><div class="led ledrd"></div></td>
                    <td><div class="led ledrd"></div></td>
                </tr>
                <tr class="usb-tx-meter">
                    <td>USB TX</td>
                    <td><div class="led ledgr"></div></td>
                    <td><div class="led ledgr"></div></td>
                    <td><div class="led ledgr"></div></td>
                    <td><div class="led ledgr"></div></td>
                    <td><div class="led ledgr"></div></td>
                    <td><div class="led ledgr"></div></td>
                    <td><div class="led ledgr"></div></td>
                    <td><div class="led ledgr"></div></td>
                    <td><div class="led ledgr"></div></td>
                    <td><div class="led ledgr"></div></td>
                    <td><div class="led ledgr"></div></td>
                    <td><div class="led ledyl"></div></td>
                    <td><div class="led ledyl"></div></td>
                    <td><div class="led ledyl"></div></td>
                    <td><div class="led ledrd"></div></td>
                    <td><div class="led ledrd"></div></td>
                    <td><div class="led ledrd"></div></td>
                </tr>
                <tr class="net-rx-meter">
                    <td>NET RX</td>
                    <td><div class="led ledgr"></div></td>
                    <td><div class="led ledgr"></div></td>
                    <td><div class="led ledgr"></div></td>
                    <td><div class="led ledgr"></div></td>
                    <td><div class="led ledgr"></div></td>
                    <td><div class="led ledgr"></div></td>
                    <td><div class="led ledgr"></div></td>
                    <td><div class="led ledgr"></div></td>
                    <td><div class="led ledgr"></div></td>
                    <td><div class="led ledgr"></div></td>
                    <td><div class="led ledgr"></div></td>
                    <td><div class="led ledyl"></div></td>
                    <td><div class="led ledyl"></div></td>
                    <td><div class="led ledyl"></div></td>
                    <td><div class="led ledrd"></div></td>
                    <td><div class="led ledrd"></div></td>
                    <td><div class="led ledrd"></div></td>
                </tr>
                <tr class="net-tx-meter">
                    <td>NET TX</td>
                    <td><div class="led ledgr"></div></td>
                    <td><div class="led ledgr"></div></td>
                    <td><div class="led ledgr"></div></td>
                    <td><div class="led ledgr"></div></td>
                    <td><div class="led ledgr"></div></td>
                    <td><div class="led ledgr"></div></td>
                    <td><div class="led ledgr"></div></td>
                    <td><div class="led ledgr"></div></td>
                    <td><div class="led ledgr"></div></td>
                    <td><div class="led ledgr"></div></td>
                    <td><div class="led ledgr"></div></td>
                    <td><div class="led ledyl"></div></td>
                    <td><div class="led ledyl"></div></td>
                    <td><div class="led ledyl"></div></td>
                    <td><div class="led ledrd"></div></td>
                    <td><div class="led ledrd"></div></td>
                    <td><div class="led ledrd"></div></td>
                </tr>
                <tr class="legend">
                    <td></td>
                    <td>-50</td>
                    <td>-40</td>
                    <td>-36</td>
                    <td>-32</td>
                    <td>-28</td>
                    <td>-24</td>
                    <td>-16</td>
                    <td>-14</td>
                    <td>-12</td>
                    <td>-10</td>
                    <td>-8</td>
                    <td>-6</td>
                    <td>-4</td>
                    <td>-3</td>
                    <td>-2</td>
                    <td>-1</td>
                    <td>0</td>
                </tr>
            </table>
         </div>
    </div>


        </form>
        <hr/>
        <a href="config">Configuration</a>
        <br/>
        <br/>
        <span><i>Bruce MacKinnon KC1FSZ bruce@mackinnon.com</i></span>
    </body>
    <script>

// This array establishes the top power level for each LED
const audioLevels = [
    { top: -50 },
    { top: -40 },
    { top: -36 },
    { top: -32 },
    { top: -28 },
    { top: -24 },
    { top: -16 },
    { top: -14 },
    { top: -12 }, 
    { top: -10 },
    { top:  -8 },
    { top:  -6 },
    { top:  -4 },
    { top:  -3 },
    { top:  -2 },
    { top:  -1 },
    { top:   0 }
];

/**
 * Renders the level meter by turning on the correct number of LEDs
 * based on the level provided.
 * 
 * @param meterClass The class name of the parent container of the LEDs that 
 * are being controlled.
 */
function setAudioLevel(meterClass, levelDb) {
    const container = document.querySelector("." + meterClass);
    if (container) {
        leds = container.querySelectorAll(".led")
        count = 0
        if (levelDb > -60) {
            count = 1
            while (count < audioLevels.length && levelDb != -Infinity && 
                levelDb >= audioLevels[count].top)
                count++;
        }
        leds.forEach((el, index) => 
            el.style.visibility = (index < count) ? "visible" : "hidden"
        );
    }
}

async function status_update() {
    const response = await fetch('status');
    if (response.ok) {

        const data = await response.json();

        setAudioLevel("usb-rx-meter", data["usb-rx-meter"]);
        setAudioLevel("usb-tx-meter", data["usb-tx-meter"]);
        setAudioLevel("net-rx-meter", data["net-rx-meter"]);
        setAudioLevel("net-tx-meter", data["net-tx-meter"]);
        
        // #### CLEAN UP
        if (data["cos"]) {
            document.getElementById("cos-active").hidden = false
            document.getElementById("cos-inactive").hidden = true
        } else {
            document.getElementById("cos-active").hidden = true
            document.getElementById("cos-inactive").hidden = false
        }
        if (data["ptt"]) {
            document.getElementById("ptt-button").classList.add("selected")
        } else {
            document.getElementById("ptt-button").classList.remove("selected")
        }

        tbody = document.getElementById("connection-table-body")
        tbody.replaceChildren();
        for (c of data["connections"]) {

            var tr = document.createElement('tr');
            var td0 = document.createElement('td');
            var td1 = document.createElement('td');
            var td2 = document.createElement('td');

            tr.appendChild(td0);
            tr.appendChild(td1);
            tr.appendChild(td2);
            
            var a0 = document.createElement('a');
            a0.innerHTML = c["localNode"];
            a0.setAttribute("href", "https://stats.allstarlink.org/stats/" + c["localNode"]);
            td0.appendChild(a0);

            var a1 = document.createElement('a');
            a1.innerHTML = c["remoteNode"];
            a1.setAttribute("href", "https://stats.allstarlink.org/stats/" + c["remoteNode"]);
            td1.appendChild(a1);

            var first = true;
            for (c1 of c["connections"]) {
                if (!first) {
                    var s = document.createElement("span");
                    s.innerHTML = "&nbsp;"
                    td2.appendChild(s);
                }
                var s = document.createElement("a");
                s.innerHTML = c1;
                s.setAttribute("href", "https://stats.allstarlink.org/stats/" + c1);
                td1.appendChild(s);
                first = false;
            }
            tbody.appendChild(tr);
        }
    }
}

function status_save(buttonName) {
    const form = document.getElementById('status-form');
    const formData = new FormData(form);
    const formObject = Object.fromEntries(formData.entries());

    if (buttonName == "fav0") {
        buttonName = "call"
        formObject["node"] = "55553"
    } else if (buttonName == "fav1") {
        buttonName = "call"
        formObject["node"] = "61057"
    } else if (buttonName == "fav2") {
        buttonName = "call"
        formObject["node"] = "27339"
    }

    formObject["button"] = buttonName;
    const jsonString = JSON.stringify(formObject, null, 2);
    fetch('/status-save', {
        method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: jsonString,
        }
    );
}

document.addEventListener('DOMContentLoaded', async () => {

    document.getElementById("cos-active").hidden = true
    setAudioLevel("usb-rx-meter", -99);
    setAudioLevel("usb-tx-meter", -99);
    setAudioLevel("net-rx-meter", -99);
    setAudioLevel("net-tx-meter", -99);

    // Fast timer to get live updates from the server
    setInterval(async () => {
        status_update();
    }, 500);

    // Handler for push buttons
    document.getElementById('status-form').addEventListener('submit', function (event) {
        event.preventDefault();
        status_save(event.submitter.name);
        // Clear the entry 
        document.getElementById('node').value = ""
        status_update();
    });   
});
    </script>
</html>
