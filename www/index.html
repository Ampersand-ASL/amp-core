<!--
Ampersand ASL Server Project
Copyright (C) 2026, Bruce MacKinnon KC1FSZ
-->
<html>
    <head>
        <title>Ampersand Home Page</title>
        <link rel="stylesheet" href="main.css">
        <style>
#node {
    margin-right: 10px;
}

#connect-button {
    margin-right: 10px;
}

#ptt-button {
    width: 200px;
    height: 40px;
}

#ptt-button.selected {
    background-color: green;
}

.dtmf-button {
    width: 30px;
    height: 30px;
}

.led-table td {
    padding: 2px;
}

.led-table tr.legend td {
    font-size: 6px;
    text-align: center;
    border-top: 1px solid white;
}

.led {
  width: 10px; 
  height: 10px; 
  border-radius: 2px; 
  visibility: hidden;
}

.led-table tr td:first-child {
    text-align: right;
    font-size: 10px;
}

.ledgr {
  background-color: green;  
}

.ledyl {
  background-color: yellow;  
}

.ledrd {
  background-color: red;
}

.bottom-row {
    display: flex;
    gap: 20px;
}

/* ----- Connection Table ------ */

.connection-table {
    width: 100%;
    table-layout: fixed;
    border-collapse: collapse;
    border: 1px solid #dddddd;
    font-size: 12px;
}

.connection-table th, .connection-table td {
  padding: 3px;
  overflow: hidden;
  border: 1px solid #dddddd;
}

.connection-table td {
  font-family: monospace;
}

.connection-table th:nth-child(1),
.connection-table td:nth-child(1) {
  width: 60px;
}

.connection-table th:nth-child(2),
.connection-table td:nth-child(2) {
  width: 150px;
}

/* Nothing specified for column 3, floats to fill width */

.connection-table th:nth-child(4),
.connection-table td:nth-child(4) {
  width: 50px;
  text-align: center;    
}

.connection-table th {
    background-color: #444444;
}

.connection-active {
    background-color: rgb(1, 58, 1);
}

.connection-node {
    margin: 2px;
}

.connection-node-active {
    color: greenyellow;
    font-weight: bold;
}

.node-container {
  display: flex;
  flex-wrap: wrap;
}
        </style>
    </head>
    <body>
        <div class="title-row">
            <span class="title-span">Ampersand ASL Server</span>
        </div>
        <div class="tab-row" role="tablist">
            <div class="tab" role="tab" aria-selected="true">
                <a href="/">Home</a>
            </div>
            <div class="tab" role="tab" aria-selected="false">
                <a href="config">Configuration</a>
            </div>
            <div class="tab" role="tab" aria-selected="false">
                <a href="log">Log</a>
            </div>
        </div>
        <div class="content-row" role="tabpanel">
            <form id="status-form">
                <input class="green-button" type="submit" value="ASL Parrot" data-user-info='{ "action": "call", "node": "61057" }'/>
                <input class="green-button" type="submit" value="TX Parrot"  data-user-info='{ "action": "call", "node": "55553" }'/>
                <br/>
                <br/>
                <input id="node" name="node" type="text" placeholder="Node Number"/>
                <input class="green-button" id="connect-button" type="submit" value="Connect" data-user-info='{ "action": "call", "node": "_ENTRY" }'/>
                <br/>
                <br/>
                <input class="red-button" id="disconnect-button" type="submit" value="Disconnect All"data-user-info='{ "action": "dropall" }'/>
                <p>Connections:</p>
                <table class="connection-table">
                    <thead>
                        <th>Node</th>
                        <th>Last Talker</th>
                        <th>Connections</th>
                        <th></th>
                    </thead>
                    <tbody id="connection-table-body">
                    </tbody>
                </table>
                <br/>
                <input class="grey-button" id="ptt-button" type="submit" value="PTT" data-user-info='{ "action": "ptt" }'/>
                <br/>
                <br/>
                <input class="grey-button" id="capture-button" type="submit" value="Capture" data-user-info='{ "action": "capture" }'/>
                <br/>
                <br/>
                <br/>
                <!-- Organizes the DTMF pad and the Level meters -->
                <div class="bottom-row">
                    <!-- Left Side-->
                    <div>
                        <table>
                            <tr>
                                <td><input class="grey-button dtmf-button" id="dtmf1-button" type="submit" value="1" data-user-info='{ "action": "dtmf", "symbol": "1" }'/></td>
                                <td><input class="grey-button dtmf-button" id="dtmf2-button" type="submit" value="2" data-user-info='{ "action": "dtmf", "symbol": "2" }'/></td>
                                <td><input class="grey-button dtmf-button" id="dtmf3-button" type="submit" value="3" data-user-info='{ "action": "dtmf", "symbol": "3" }'/></td>
                                <td><input class="grey-button dtmf-button" id="dtmfA-button" type="submit" value="A" data-user-info='{ "action": "dtmf", "symbol": "A" }'/></td>
                            </tr>
                            <tr>
                                <td><input class="grey-button dtmf-button" id="dtmf4-button" type="submit" value="4" data-user-info='{ "action": "dtmf", "symbol": "4" }'/></td>
                                <td><input class="grey-button dtmf-button" id="dtmf5-button" type="submit" value="5" data-user-info='{ "action": "dtmf", "symbol": "5" }'/></td>
                                <td><input class="grey-button dtmf-button" id="dtmf6-button" type="submit" value="6" data-user-info='{ "action": "dtmf", "symbol": "6" }'/></td>
                                <td><input class="grey-button dtmf-button" id="dtmfB-button" type="submit" value="B" data-user-info='{ "action": "dtmf", "symbol": "B" }'/></td>
                            </tr>
                            <tr>
                                <td><input class="grey-button dtmf-button" id="dtmf7-button" type="submit" value="7" data-user-info='{ "action": "dtmf", "symbol": "7" }'/></td>
                                <td><input class="grey-button dtmf-button" id="dtmf8-button" type="submit" value="8" data-user-info='{ "action": "dtmf", "symbol": "8" }'/></td>
                                <td><input class="grey-button dtmf-button" id="dtmf9-button" type="submit" value="9" data-user-info='{ "action": "dtmf", "symbol": "9" }'/></td>
                                <td><input class="grey-button dtmf-button" id="dtmfc-button" type="submit" value="C" data-user-info='{ "action": "dtmf", "symbol": "C" }'/></td>
                            </tr>
                            <tr>
                                <td><input class="grey-button dtmf-button" id="dtmfstar-button"  type="submit" value="*" data-user-info='{ "action": "dtmf", "symbol": "*" }'/></td>
                                <td><input class="grey-button dtmf-button" id="dtmf0-button"     type="submit" value="0" data-user-info='{ "action": "dtmf", "symbol": "0" }'/></td>
                                <td><input class="grey-button dtmf-button" id="dtmfpound-button" type="submit" value="#" data-user-info='{ "action": "dtmf", "symbol": "#" }'/></td>
                                <td><input class="grey-button dtmf-button" id="dtmfD-button"     type="submit" value="D" data-user-info='{ "action": "dtmf", "symbol": "D" }'/></td>
                            </tr>
                        </table>
                    </div>
                    <!-- Right Side-->
                    <div>
                        <table class="no-border-table led-table">
                            <tr class="usb-rx-meter">
                                <td>USB RX</td>
                                <td><div class="led ledgr"></div></td>
                                <td><div class="led ledgr"></div></td>
                                <td><div class="led ledgr"></div></td>
                                <td><div class="led ledgr"></div></td>
                                <td><div class="led ledgr"></div></td>
                                <td><div class="led ledgr"></div></td>
                                <td><div class="led ledgr"></div></td>
                                <td><div class="led ledgr"></div></td>
                                <td><div class="led ledgr"></div></td>
                                <td><div class="led ledgr"></div></td>
                                <td><div class="led ledgr"></div></td>
                                <td><div class="led ledyl"></div></td>
                                <td><div class="led ledyl"></div></td>
                                <td><div class="led ledyl"></div></td>
                                <td><div class="led ledrd"></div></td>
                                <td><div class="led ledrd"></div></td>
                                <td><div class="led ledrd"></div></td>
                            </tr>
                            <tr class="usb-tx-meter">
                                <td>USB TX</td>
                                <td><div class="led ledgr"></div></td>
                                <td><div class="led ledgr"></div></td>
                                <td><div class="led ledgr"></div></td>
                                <td><div class="led ledgr"></div></td>
                                <td><div class="led ledgr"></div></td>
                                <td><div class="led ledgr"></div></td>
                                <td><div class="led ledgr"></div></td>
                                <td><div class="led ledgr"></div></td>
                                <td><div class="led ledgr"></div></td>
                                <td><div class="led ledgr"></div></td>
                                <td><div class="led ledgr"></div></td>
                                <td><div class="led ledyl"></div></td>
                                <td><div class="led ledyl"></div></td>
                                <td><div class="led ledyl"></div></td>
                                <td><div class="led ledrd"></div></td>
                                <td><div class="led ledrd"></div></td>
                                <td><div class="led ledrd"></div></td>
                            </tr>
                            <!--
                            <tr class="net-rx-meter">
                                <td>NET RX</td>
                                <td><div class="led ledgr"></div></td>
                                <td><div class="led ledgr"></div></td>
                                <td><div class="led ledgr"></div></td>
                                <td><div class="led ledgr"></div></td>
                                <td><div class="led ledgr"></div></td>
                                <td><div class="led ledgr"></div></td>
                                <td><div class="led ledgr"></div></td>
                                <td><div class="led ledgr"></div></td>
                                <td><div class="led ledgr"></div></td>
                                <td><div class="led ledgr"></div></td>
                                <td><div class="led ledgr"></div></td>
                                <td><div class="led ledyl"></div></td>
                                <td><div class="led ledyl"></div></td>
                                <td><div class="led ledyl"></div></td>
                                <td><div class="led ledrd"></div></td>
                                <td><div class="led ledrd"></div></td>
                                <td><div class="led ledrd"></div></td>
                            </tr>
                            <tr class="net-tx-meter">
                                <td>NET TX</td>
                                <td><div class="led ledgr"></div></td>
                                <td><div class="led ledgr"></div></td>
                                <td><div class="led ledgr"></div></td>
                                <td><div class="led ledgr"></div></td>
                                <td><div class="led ledgr"></div></td>
                                <td><div class="led ledgr"></div></td>
                                <td><div class="led ledgr"></div></td>
                                <td><div class="led ledgr"></div></td>
                                <td><div class="led ledgr"></div></td>
                                <td><div class="led ledgr"></div></td>
                                <td><div class="led ledgr"></div></td>
                                <td><div class="led ledyl"></div></td>
                                <td><div class="led ledyl"></div></td>
                                <td><div class="led ledyl"></div></td>
                                <td><div class="led ledrd"></div></td>
                                <td><div class="led ledrd"></div></td>
                                <td><div class="led ledrd"></div></td>
                            </tr>
                            -->
                            <tr class="legend">
                                <td></td>
                                <td>-50</td>
                                <td>-40</td>
                                <td>-36</td>
                                <td>-32</td>
                                <td>-28</td>
                                <td>-24</td>
                                <td>-16</td>
                                <td>-14</td>
                                <td>-12</td>
                                <td>-10</td>
                                <td>-8</td>
                                <td>-6</td>
                                <td>-4</td>
                                <td>-3</td>
                                <td>-2</td>
                                <td>-1</td>
                                <td>0</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </form>
        </div> <!-- /content-row -->
        <div class="footer-row">
            <span><i><a href="https://www.qrz.com/db/KC1FSZ">Bruce MacKinnon KC1FSZ bruce@mackinnon.com</a></i></span>
        </div> <!-- /footer-row -->
    </body>
    <script>

// This array establishes the top power level for each LED
const audioLevels = [
    { top: -50 },
    { top: -40 },
    { top: -36 },
    { top: -32 },
    { top: -28 },
    { top: -24 },
    { top: -16 },
    { top: -14 },
    { top: -12 }, 
    { top: -10 },
    { top:  -8 },
    { top:  -6 },
    { top:  -4 },
    { top:  -3 },
    { top:  -2 },
    { top:  -1 },
    { top:   0 }
];

/**
 * Renders the level meter by turning on the correct number of LEDs
 * based on the level provided.
 * 
 * @param meterClass The class name of the parent container of the LEDs that 
 * are being controlled.
 */
function setAudioLevel(meterClass, levelDb) {
    const container = document.querySelector("." + meterClass);
    if (container) {
        leds = container.querySelectorAll(".led")
        count = 0
        if (levelDb > -60) {
            count = 1
            while (count < audioLevels.length && levelDb != -Infinity && 
                levelDb >= audioLevels[count].top)
                count++;
        }
        leds.forEach((el, index) => 
            el.style.visibility = (index < count) ? "visible" : "hidden"
        );
    }
}

async function status_update() {
    const response = await fetch('status');
    if (response.ok) {

        const data = await response.json();

        //setAudioLevel("usb-rx-meter", data["usb-rx-meter"]);
        //setAudioLevel("usb-tx-meter", data["usb-tx-meter"]);
        //setAudioLevel("net-rx-meter", data["net-rx-meter"]);
        //setAudioLevel("net-tx-meter", data["net-tx-meter"]);
        
        if (data["ptt"]) {
            document.getElementById("ptt-button").classList.add("selected")
        } else {
            document.getElementById("ptt-button").classList.remove("selected")
        }

        tbody = document.getElementById("connection-table-body")
        tbody.replaceChildren();
        if ("calls" in data)
            for (c of data["calls"]) 
                tbody.appendChild(makeCallRow(c));
    }
}

// Creates a row that looks like this:
//
// <tr>
//   <td>
//     <span></span>
//   </td
//   <td>
//     <a></a>
//   </td
// </tr>

function makeCallRow(conn) {

    var tr = document.createElement('tr');
    // Row-level styling
    if (conn["rxActive"])
        tr.classList.add("connection-active");
    var td0 = document.createElement('td');
    var td1 = document.createElement('td');
    var td2 = document.createElement('td');
    var td3 = document.createElement('td');

    tr.appendChild(td0);
    tr.appendChild(td1);
    tr.appendChild(td2);
    tr.appendChild(td3);

    var a0 = document.createElement('a');
    a0.innerHTML = c["remoteNode"];
    a0.setAttribute("href", "https://stats.allstarlink.org/stats/" + c["remoteNode"]);
    td0.appendChild(a0);

    // The first token in the talker string gets treated like a callsign
    var talkerid = c["talkerid"].trim()
    if (talkerid.length > 0) {
        var sp1 = document.createElement('span');
        sp1.innerHTML = talkerid;
        td1.appendChild(sp1);
    }

    var cd = document.createElement("div");
    cd.classList.add("node-container");
    for (c1 of c["connections"]) {
        var a = document.createElement("a");
        a.classList.add("connection-node");
        if (c1["active"]) 
            a.classList.add("connection-node-active");
        a.innerHTML = c1["node"];
        a.setAttribute("href", "https://stats.allstarlink.org/stats/" + c1["node"]);
        cd.appendChild(a);
    }
    td2.appendChild(cd);

    // Disconnect button
    b = document.createElement("input")
    b.classList.add("red-button")
    b.type = "submit"
    b.value = "Disc"
    // Attach the command that will be send on press
    b.setAttribute('data-user-info', JSON.stringify({
        "action": "dropcall",
        "lineId": conn["lineId"],
        "callId": conn["callId"]
    }));
    td3.appendChild(b)

    return tr;
}

// The same handler is put on all of the submit buttons on the screen.
// Everything is driven by the name of the button that was pressed.
function status_pressed(button) {

    const form = document.getElementById('status-form');
    const formData = new FormData(form);
    const formObject = Object.fromEntries(formData.entries());

    // Take a copy of the event object off the button
    console.log(button.getAttribute("data-user-info"));
    msg = JSON.parse(button.getAttribute("data-user-info"));
    console.log(msg)
    // Look for the magic string _ENTRY in the command message that indicates
    // that we should read from ehe input box.
    if ("node" in msg && msg["node"] == "_ENTRY")
        msg["node"] = formObject["node"]
    // Post down
    fetch('/status-pressed', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(msg, null, 2)
        }
    );
}

document.addEventListener('DOMContentLoaded', async () => {

    setAudioLevel("usb-rx-meter", -99);
    setAudioLevel("usb-tx-meter", -99);
    setAudioLevel("net-rx-meter", -99);
    setAudioLevel("net-tx-meter", -99);

    // Fast timer to get live updates from the server
    setInterval(async () => {
        status_update();
    }, 500);

    // Handler for push buttons
    document.getElementById('status-form').addEventListener('submit', function (event) {
        event.preventDefault();
        status_pressed(event.submitter);
        // Clear the entry field
        document.getElementById('node').value = ""
        status_update();
    });   

    status_update();
});
    </script>
</html>
